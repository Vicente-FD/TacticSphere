<div class="ts-page">
  <div class="ts-container space-y-6">
    <section class="ts-card space-y-6">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="ts-title">Resultados analiticos</h1>
          <p class="ts-subtitle">
            Explora el desempeno agregado por empresa, departamento, empleado y pilar.
          </p>
        </div>
        <div class="flex flex-wrap gap-2 text-sm">
          <ng-container *ngFor="let card of kpiCards(); trackBy: trackById">
            <div class="ts-chip">
              <span class="uppercase text-[11px] tracking-[0.08em] text-neutral-400">{{ card.label }}</span>
              <span class="ml-2 text-lg font-semibold text-ink">{{ card.value }}</span>
              <span *ngIf="card.suffix" class="ml-1 text-sm text-neutral-400">{{ card.suffix }}</span>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-5">
        <label class="block space-y-2">
          <span class="ts-label">Ambito</span>
          <select class="ts-select" [(ngModel)]="scopeModel" (ngModelChange)="onScopeChange()">
            <option value="GLOBAL">Global</option>
            <option value="COMPANY">Por empresa</option>
            <option value="DEPARTMENT">Por departamento</option>
            <option value="EMPLOYEE">Por empleado</option>
          </select>
        </label>

        <label class="block space-y-2" *ngIf="requiresCompany()">
          <span class="ts-label">Empresa</span>
          <select class="ts-select" [(ngModel)]="selectedCompanyId" (ngModelChange)="onCompanyChange($event)">
            <option [ngValue]="null">Selecciona empresa...</option>
            <option *ngFor="let company of companies()" [ngValue]="company.id">{{ company.nombre }}</option>
          </select>
        </label>

        <label class="block space-y-2" *ngIf="requiresDepartment()">
          <span class="ts-label">Departamento</span>
          <select class="ts-select" [(ngModel)]="selectedDepartmentId" (ngModelChange)="onDepartmentChange($event)">
            <option [ngValue]="null">Selecciona departamento...</option>
            <option *ngFor="let dept of departments()" [ngValue]="dept.id">{{ dept.nombre }}</option>
          </select>
        </label>

        <label class="block space-y-2" *ngIf="pillarOptions().length">
          <span class="ts-label">Pilar</span>
          <select class="ts-select" [(ngModel)]="selectedPillar" (ngModelChange)="onPillarChange($event)">
            <option [ngValue]="'ALL'">Todos los pilares</option>
            <option *ngFor="let pillar of pillarOptions()" [ngValue]="pillar.id">{{ pillar.name }}</option>
          </select>
        </label>

        <label class="block space-y-2" *ngIf="scopeModel === 'EMPLOYEE'">
          <span class="ts-label">Empleado</span>
          <select class="ts-select" [(ngModel)]="selectedEmployeeId" (ngModelChange)="onEmployeeChange($event)">
            <option [ngValue]="null">Selecciona empleado...</option>
            <option *ngFor="let emp of filteredEmployees(); trackBy: trackById" [ngValue]="emp.id">
              {{ emp.nombre }} (ID {{ emp.id }})
            </option>
          </select>
        </label>

        <label class="block space-y-2 md:col-span-2 xl:col-span-2" *ngIf="scopeModel === 'EMPLOYEE'">
          <span class="ts-label">Buscar empleado</span>
          <input
            class="ts-input"
            type="text"
            placeholder="Nombre, correo o ID"
            [(ngModel)]="employeeSearch"
            (ngModelChange)="onEmployeeSearchChange($event)"
          />
        </label>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <button class="ts-btn ts-btn--secondary" type="button" (click)="refreshCurrentFilter()" [disabled]="loading()">
          Actualizar datos
        </button>
      </div>

      <div *ngIf="info()" class="rounded-md border border-neutral-200 bg-neutral-100 px-4 py-3 text-sm text-neutral-500">
        {{ info() }}
      </div>
      <div *ngIf="error()" class="rounded-md border border-error/30 bg-error/10 px-4 py-3 text-sm text-error">
        {{ error() }}
      </div>
    </section>

    <section class="space-y-6" *ngIf="!loading(); else loadingState">
      <ng-container *ngIf="insights().length; else emptyState">
        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card space-y-4 xl:col-span-7 min-w-0">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Desempeno por pilar</h2>
              <p class="text-sm text-neutral-400">
                Promedio global de cada pilar considerando los filtros aplicados.
              </p>
            </div>
            <echarts class="block w-full h-[26rem]" [options]="barPillarOption()" [autoResize]="true"></echarts>
          </div>

          <div class="ts-card space-y-4 xl:col-span-5 min-w-0">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Equilibrio organizacional</h2>
              <p class="text-sm text-neutral-400">Comparar la fortaleza relativa entre pilares.</p>
            </div>
            <echarts class="block w-full h-[26rem]" [options]="radarBalanceOption()" [autoResize]="true"></echarts>
          </div>
        </div>

        <div class="ts-card space-y-4 min-w-0">
          <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
            <div>
              <h2 class="text-lg font-semibold text-ink">Evolucion temporal</h2>
              <p class="text-sm text-neutral-400">Sigue la tendencia del puntaje global y del pilar seleccionado.</p>
            </div>
          </div>
          <echarts class="block w-full h-[26rem]" [options]="timelineOption()" [autoResize]="true"></echarts>
        </div>

        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card space-y-4 xl:col-span-6 min-w-0">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Participacion por departamento</h2>
              <p class="text-sm text-neutral-400">Comparativa de respuestas completadas y pendientes.</p>
            </div>
            <echarts class="block w-full h-[26rem]" [options]="departmentParticipationOption()" [autoResize]="true"></echarts>
          </div>

          <div class="ts-card space-y-4 xl:col-span-6 min-w-0">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Pilar vs departamento</h2>
              <p class="text-sm text-neutral-400">Detecta fortalezas y brechas puntuales.</p>
            </div>
            <echarts class="block w-full h-[26rem]" [options]="heatmapOption()" [autoResize]="true"></echarts>
          </div>
        </div>

        <div class="ts-card space-y-4 min-w-0">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Ranking de desempeno</h2>
            <p class="text-sm text-neutral-400">Top de departamentos o empleados segun el filtro actual.</p>
          </div>
          <echarts class="block w-full h-[26rem]" [options]="rankingOption()" [autoResize]="true"></echarts>
        </div>
      </ng-container>
    </section>

    <ng-template #loadingState>
      <section class="space-y-4">
        <div class="ts-card">
          <div class="animate-pulse space-y-4">
            <div class="h-4 w-1/4 rounded bg-neutral-200"></div>
            <div class="h-72 rounded-lg bg-neutral-200"></div>
          </div>
        </div>
        <div class="ts-card">
          <div class="animate-pulse space-y-4">
            <div class="h-4 w-1/4 rounded bg-neutral-200"></div>
            <div class="h-72 rounded-lg bg-neutral-200"></div>
          </div>
        </div>
      </section>
    </ng-template>

    <ng-template #emptyState>
      <section class="ts-card text-center text-sm text-neutral-400">
        No encontramos resultados para los filtros aplicados. Ajusta los criterios o espera a que existan nuevas
        respuestas.
      </section>
    </ng-template>
  </div>
</div>

