<div class="ts-page">
  <div class="ts-container space-y-6">
    <section class="ts-card space-y-6 animate-subtleUp">
      <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="ts-title">Dashboard analitico</h1>
          <p class="ts-subtitle">Explora la madurez digital por empresa, departamentos, empleados y pilares.</p>
        </div>
        <div class="flex flex-wrap gap-2 text-sm">
          <ng-container *ngFor="let card of kpiCards(); trackBy: trackByIndex">
            <div class="ts-chip min-w-[150px]">
              <span class="uppercase text-[11px] tracking-[0.08em] text-muted">{{ card.label }}</span>
              <span class="ml-2 text-lg font-semibold text-ink">{{ card.value }}</span>
              <span *ngIf="card.suffix" class="ml-1 text-xs text-muted">{{ card.suffix }}</span>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <button type="button" class="ts-btn ts-btn--ghost" (click)="toggleFilters()">
          {{ showFilters ? 'Ocultar filtros' : 'Mostrar filtros' }}
        </button>
        <button class="ts-btn ts-btn--secondary" type="button" (click)="refreshCurrentFilter()" [disabled]="loading()">
          Actualizar datos
        </button>
        <button class="ts-btn" type="button" (click)="exportPdf()" [disabled]="exportPdfUrlDisabled()">
          {{ exporting() ? 'Generando PDF...' : 'Exportar PDF' }}
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-6" *ngIf="showFilters">
        <label class="block space-y-2 xl:col-span-2">
          <span class="ts-label">Empresa</span>
          <select class="ts-select" [(ngModel)]="selectedCompanyId" (ngModelChange)="onCompanyChange($event)" [disabled]="isUser">
            <option [ngValue]="null">Selecciona empresa...</option>
            <option *ngFor="let company of companies(); trackBy: trackById" [ngValue]="company.id">{{ company.nombre }}</option>
          </select>
        </label>

        <label class="block space-y-2">
          <span class="ts-label">Desde</span>
          <input class="ts-input" type="date" [(ngModel)]="dateFrom" (change)="onDateChange()" />
        </label>

        <label class="block space-y-2">
          <span class="ts-label">Hasta</span>
          <input class="ts-input" type="date" [(ngModel)]="dateTo" (change)="onDateChange()" />
        </label>

        <label class="block space-y-2">
          <span class="ts-label">Departamento</span>
          <select class="ts-select" [(ngModel)]="selectedDepartmentId" (ngModelChange)="onDepartmentChange($event)">
            <option [ngValue]="null">Todos los departamentos</option>
            <option *ngFor="let dept of departments(); trackBy: trackById" [ngValue]="dept.id">{{ dept.nombre }}</option>
          </select>
        </label>

        <label class="block space-y-2">
          <span class="ts-label">Pilar</span>
          <select class="ts-select" [(ngModel)]="selectedPillar" (ngModelChange)="onPillarChange($event)">
            <option [ngValue]="'ALL'">Todos los pilares</option>
            <option *ngFor="let pillar of pillarOptions(); trackBy: trackByIndex" [ngValue]="pillar.pillar_id">
              {{ pillar.pillar_name }}
            </option>
          </select>
        </label>

        <label class="block space-y-2 xl:col-span-2">
          <span class="ts-label">Empleado</span>
          <select class="ts-select" [(ngModel)]="selectedEmployeeId" (ngModelChange)="onEmployeeChange($event)">
            <option [ngValue]="null">Todos los empleados</option>
            <option *ngFor="let emp of filteredEmployees(); trackBy: trackById" [ngValue]="emp.id">
              {{ emp.nombre }} (ID {{ emp.id }})
            </option>
          </select>
          <input
            class="ts-input mt-2"
            type="text"
            placeholder="Buscar empleado"
            [(ngModel)]="employeeSearch"
          />
        </label>
      </div>

      <div *ngIf="info()" class="rounded-2xl border border-border bg-[#f6f6f6] px-4 py-3 text-sm text-muted">
        {{ info() }}
      </div>
      <div *ngIf="error()" class="rounded-md border border-error/30 bg-error/10 px-4 py-3 text-sm text-error">
        {{ error() }}
      </div>
    </section>

    <section id="analytics-export" class="space-y-6" *ngIf="!loading(); else loadingState">
      <ng-container *ngIf="analytics(); else emptyState">
        <div class="ts-card space-y-3 min-w-0 animate-subtleUp">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Resumen del filtro actual</h2>
            <p class="text-sm text-muted">Aplicado a todos los graficos y KPIs.</p>
          </div>
          <ul class="text-sm text-muted space-y-1">
            <li *ngFor="let item of filterSummary(); trackBy: trackByIndex">{{ item }}</li>
          </ul>
        </div>

        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card space-y-4 xl:col-span-7 min-w-0 animate-subtleUp">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Desempeno por pilar</h2>
              <p class="text-sm text-muted">Promedio ponderado por pregunta. Clic para filtrar.</p>
            </div>
            <echarts
              class="block h-[26rem] w-full animate-fadeIn"
              [theme]="'tsMono'"
              [options]="barPillarOption()"
              [autoResize]="true"
              (chartClick)="onPillarBarClick($event)"
            ></echarts>
          </div>

          <div class="ts-card space-y-4 xl:col-span-5 min-w-0 animate-subtleUp">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Equilibrio organizacional</h2>
              <p class="text-sm text-muted">Comparativa radial de los pilares.</p>
            </div>
            <echarts
              class="block h-[26rem] w-full animate-fadeIn"
              [theme]="'tsMono'"
              [options]="radarBalanceOption()"
              [autoResize]="true"
            ></echarts>
          </div>
        </div>

        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card space-y-4 xl:col-span-7 min-w-0 animate-subtleUp">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Heatmap Pilar × Departamento</h2>
              <p class="text-sm text-muted">Detecta brechas especificas. Clic para profundizar.</p>
            </div>
            <echarts
              class="block h-[28rem] w-full animate-fadeIn"
              [theme]="'tsMono'"
              [options]="heatmapOption()"
              [autoResize]="true"
              (chartClick)="onHeatmapClick($event)"
            ></echarts>
          </div>

          <div class="ts-card space-y-4 xl:col-span-5 min-w-0 animate-subtleUp">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-ink">Distribucion por nivel</h2>
              <p class="text-sm text-muted">Composicion Likert de cada pilar. Ordenado por % ≥4.</p>
            </div>
            <echarts
              class="block h-[28rem] w-full animate-fadeIn"
              [theme]="'tsMono'"
              [options]="distributionOption()"
              [autoResize]="true"
            ></echarts>
          </div>
        </div>

        <div class="ts-card space-y-4 min-w-0 animate-subtleUp">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Tendencia temporal</h2>
            <p class="text-sm text-muted">Serie global y pilar focalizado (cuando aplica).</p>
          </div>
          <echarts
            class="block h-[28rem] w-full animate-fadeIn"
            [theme]="'tsMono'"
            [options]="timelineOption()"
            [autoResize]="true"
          ></echarts>
        </div>

        <div class="ts-card space-y-4 min-w-0 animate-subtleUp">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Ranking de departamentos</h2>
            <p class="text-sm text-muted">Top 5 y Bottom 5 segun el filtro actual.</p>
          </div>
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <h3 class="font-semibold text-emerald-600">Top 5</h3>
              <div class="space-y-3" *ngIf="rankingTop().length; else rankingEmpty">
                <ng-container *ngFor="let item of rankingTop(); trackBy: trackById">
                  <div class="flex justify-between text-sm font-medium text-ink">
                    <span class="mr-3 line-clamp-1">{{ item.name }}</span>
                    <span>{{ formatPercent(item.value) }}</span>
                  </div>
                  <div class="h-2 rounded bg-slate-200">
                    <div class="h-full rounded bg-emerald-500" [style.width.%]="item.value"></div>
                  </div>
                </ng-container>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-rose-600">Bottom 5</h3>
              <div class="space-y-3" *ngIf="rankingBottom().length; else rankingEmpty">
                <ng-container *ngFor="let item of rankingBottom(); trackBy: trackById">
                  <div class="flex justify-between text-sm font-medium text-ink">
                    <span class="mr-3 line-clamp-1">{{ item.name }}</span>
                    <span>{{ formatPercent(item.value) }}</span>
                  </div>
                  <div class="h-2 rounded bg-slate-200">
                    <div class="h-full rounded bg-rose-500" [style.width.%]="item.value"></div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
          <ng-template #rankingEmpty>
            <p class="text-sm text-muted">Sin datos suficientes.</p>
          </ng-template>
        </div>

        <div class="ts-card space-y-4 min-w-0 animate-subtleUp" *ngIf="hasEmployeesDistribution()">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Dispersión de empleados</h2>
            <p class="text-sm text-muted">Promedio individual y estadio asociado.</p>
          </div>
          <echarts
            class="block h-[26rem] w-full animate-fadeIn"
            [theme]="'tsMono'"
            [options]="employeeScatterOption()"
            [autoResize]="true"
          ></echarts>
        </div>
      </ng-container>
    </section>

    <ng-template #loadingState>
      <section class="space-y-4">
        <div class="ts-card">
          <div class="animate-pulse space-y-4">
            <div class="h-4 w-1/4 rounded bg-border"></div>
            <div class="h-72 rounded-lg bg-border"></div>
          </div>
        </div>
        <div class="ts-card">
          <div class="animate-pulse space-y-4">
            <div class="h-4 w-1/5 rounded bg-border"></div>
            <div class="h-72 rounded-lg bg-border"></div>
          </div>
        </div>
      </section>
    </ng-template>

    <ng-template #emptyState>
      <section class="ts-card text-center text-sm text-muted">
        No encontramos resultados para los filtros aplicados. Ajusta los criterios o espera nuevas respuestas.
      </section>
    </ng-template>
  </div>
</div>
