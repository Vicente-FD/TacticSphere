<div class="ts-page">
  <div class="ts-container space-y-6">
    <!-- Card 1: Filtros -->
    <section class="ts-card space-y-6 animate-subtleUp">
      <div class="space-y-1">
        <h2 class="text-lg font-semibold text-ink">Filtros</h2>
        <p class="text-sm text-muted">Selecciona los criterios para analizar los datos.</p>
      </div>

      <div class="grid gap-6">

        <div class="grid gap-6 xl:grid-cols-3">
          <div class="rounded-2xl border border-[#E2E8F0] bg-white/80 p-5 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#64748B]">Datos</p>
            <div class="mt-4 grid gap-4">
              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Empresa</span>
                <select
                  class="ts-select rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  [(ngModel)]="selectedCompanyId"
                  (ngModelChange)="onCompanyChange($event)"
                  [disabled]="isUser"
                  panelClass="ts-select-panel"
                >
                  <option [ngValue]="null">Selecciona empresa...</option>
                  <option *ngFor="let company of companies(); trackBy: trackById" [ngValue]="company.id">{{ company.nombre }}</option>
                </select>
              </label>

              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Departamento</span>
                <select
                  class="ts-select rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  [(ngModel)]="selectedDepartmentId"
                  (ngModelChange)="onDepartmentChange($event)"
                  panelClass="ts-select-panel"
                >
                  <option [ngValue]="null">Todos los departamentos</option>
                  <option *ngFor="let dept of departments(); trackBy: trackById" [ngValue]="dept.id">{{ dept.nombre }}</option>
                </select>
              </label>

              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Pilar</span>
                <select
                  class="ts-select rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  [(ngModel)]="selectedPillar"
                  (ngModelChange)="onPillarChange($event)"
                  panelClass="ts-select-panel"
                >
                  <option [ngValue]="'ALL'">Todos los pilares</option>
                  <option *ngFor="let pillar of pillarOptions(); trackBy: trackByIndex" [ngValue]="pillar.pillar_id">
                    {{ pillar.pillar_name }}
                  </option>
                </select>
              </label>
            </div>
          </div>

          <div class="rounded-2xl border border-[#E2E8F0] bg-white/80 p-5 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#64748B]">Colaboradores</p>
            <div class="mt-4 grid gap-4">
              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Empleado</span>
                <select
                  class="ts-select rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  [(ngModel)]="selectedEmployeeId"
                  (ngModelChange)="onEmployeeChange($event)"
                  panelClass="ts-select-panel"
                >
                  <option [ngValue]="null">Todos los empleados</option>
                  <option *ngFor="let emp of filteredEmployees(); trackBy: trackById" [ngValue]="emp?.id ?? null">
                    {{ emp ? formatEmployeeIdentity(emp) : 'Empleado inválido' }}
                  </option>
                </select>
              </label>

              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Buscar empleado</span>
                <input
                  class="ts-input rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  type="text"
                  placeholder="Nombre, correo o RUT"
                  [ngModel]="employeeSearch"
                  (ngModelChange)="onEmployeeSearchChange($event)"
                />
              </label>
            </div>
          </div>

          <div class="rounded-2xl border border-[#E2E8F0] bg-white/80 p-5 shadow-sm">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#64748B]">Periodo</p>
            <div class="mt-4 grid gap-4">
              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Desde</span>
                <input
                  class="ts-input rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  type="date"
                  [(ngModel)]="dateFrom"
                  (change)="onDateChange()"
                />
              </label>

              <label class="block space-y-2">
                <span class="ts-label text-sm font-semibold text-[#0F172A]">Hasta</span>
                <input
                  class="ts-input rounded-xl border border-[#D7DFEA] bg-white px-4 py-2.5 text-[#1E293B]"
                  type="date"
                  [(ngModel)]="dateTo"
                  (change)="onDateChange()"
                />
              </label>
            </div>
          </div>
        </div>

        <div *ngIf="info()" class="rounded-2xl border border-border bg-[#F8FAFC] px-4 py-3 text-sm text-muted">
          {{ info() }}
        </div>
        <div *ngIf="error()" class="rounded-md border border-error/30 bg-error/10 px-4 py-3 text-sm text-error">
          {{ error() }}
        </div>

        <div class="flex flex-wrap items-center justify-center gap-3">
          <button class="ts-btn ts-btn--secondary" type="button" (click)="refreshCurrentFilter()" [disabled]="loading()">
            Actualizar datos
          </button>
          <button class="ts-btn" type="button" (click)="openReportModal()" [disabled]="loading() || !analytics()">
            Generar informes
          </button>
          <button class="ts-btn ts-btn--secondary" type="button" (click)="clearFilters()" [disabled]="loading()">
            Limpiar filtros
          </button>
        </div>

      </div>
    </section>

    <!-- Card 2: Resultados del dashboard -->
    <section id="analytics-export" class="ts-card space-y-6 animate-subtleUp" *ngIf="!loading(); else loadingState">
      <div class="space-y-1">
        <h2 class="text-lg font-semibold text-ink">Resultados del dashboard</h2>
        <p class="text-sm text-muted">Métricas y visualizaciones basadas en los filtros aplicados.</p>
      </div>

      <ng-container *ngIf="analytics(); else emptyState">
        <!-- KPIs principales -->
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          <ng-container *ngFor="let card of kpiCards(); trackBy: trackByIndex">
            <div 
              class="rounded-2xl border bg-white px-4 py-3 shadow-[0_6px_18px_rgba(2,6,23,0.06)]" 
              [class.relative]="card.color"
              [style.border-color]="card.color || '#E2E8F0'"
              [style.border-width]="card.color ? '2px' : '1px'"
            >
              <p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-[#64748B]">{{ card.label }}</p>
              <div class="mt-1 flex items-baseline gap-2">
                <span class="text-2xl font-semibold" [style.color]="card.color || '#0F172A'">{{ card.value }}</span>
                <span *ngIf="card.suffix" class="text-xs font-medium text-[#94A3B8]">{{ card.suffix }}</span>
              </div>
              <!-- Indicador de color para Estadio actual -->
              <div *ngIf="card.color && card.label === 'Estadio actual'" class="absolute top-3 right-3 w-3 h-3 rounded-full" [style.background-color]="card.color"></div>
            </div>
          </ng-container>
        </div>

        <!-- Estadios Likert -->
        <app-likert-buckets
          [employees]="likertBucketEmployees()"
          [filter]="likertBucketsFilter()"
          (employeeClick)="onLikertEmployeeClick($event)"
        ></app-likert-buckets>

        <!-- Resumen del filtro actual -->
        <div class="ts-card space-y-3 min-w-0 animate-subtleUp" *ngIf="shouldShowFilterSummary()">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Resumen del filtro actual</h2>
            <p class="text-sm text-muted">Aplicado a todos los graficos y KPIs.</p>
          </div>
          <ul class="text-sm text-muted space-y-1">
            <li *ngFor="let item of filterSummary(); trackBy: trackByIndex">{{ item }}</li>
          </ul>
        </div>

        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card ts-card--flush space-y-4 xl:col-span-7 min-w-0 animate-subtleUp">
            <div class="space-y-1 px-6">
              <h2 class="text-lg font-semibold text-ink">Desempeno por pilar</h2>
              <p class="text-sm text-muted">Promedio ponderado por pregunta. Clic para filtrar.</p>
            </div>
            <div class="px-0">
              <echarts
                class="block h-[26rem] w-full animate-fadeIn"
                [theme]="'tsMono'"
                [options]="barPillarOption()"
                [initOpts]="chartInitOpts"
                [autoResize]="true"
                (chartClick)="onPillarBarClick($event)"
              ></echarts>
            </div>
          </div>

          <div class="ts-card ts-card--flush space-y-4 xl:col-span-5 min-w-0 animate-subtleUp">
            <div class="space-y-1 px-6">
              <h2 class="text-lg font-semibold text-ink">Equilibrio organizacional</h2>
              <p class="text-sm text-muted">Comparativa radial de los pilares.</p>
            </div>
            <div class="px-0">
              <echarts
                class="block h-[26rem] w-full animate-fadeIn"
                [theme]="'tsMono'"
                [options]="radarBalanceOption()"
                [initOpts]="chartInitOpts"
                [autoResize]="true"
              ></echarts>
            </div>
          </div>
        </div>

        <div class="grid gap-6 xl:grid-cols-12">
          <div class="ts-card ts-card--flush space-y-4 xl:col-span-7 min-w-0 animate-subtleUp">
            <div class="space-y-1 px-6">
              <h2 class="text-lg font-semibold text-ink">Heatmap Pilar × Departamento</h2>
              <p class="text-sm text-muted">Detecta brechas especificas. Clic para profundizar.</p>
            </div>
            <div class="px-0">
              <echarts
                class="block h-[28rem] w-full animate-fadeIn"
                [theme]="'tsMono'"
                [options]="heatmapOption()"
                [initOpts]="chartInitOpts"
                [autoResize]="true"
                (chartClick)="onHeatmapClick($event)"
              ></echarts>
            </div>
          </div>

          <div class="ts-card ts-card--flush space-y-4 xl:col-span-5 min-w-0 animate-subtleUp">
            <div class="space-y-1 px-6">
              <h2 class="text-lg font-semibold text-ink">Distribucion por nivel</h2>
              <p class="text-sm text-muted">Composicion Likert de cada pilar. Ordenado por % ≥4.</p>
            </div>
            <div class="px-0">
              <echarts
                class="block h-[28rem] w-full animate-fadeIn"
                [theme]="'tsMono'"
                [options]="distributionOption()"
                [initOpts]="chartInitOpts"
                [autoResize]="true"
              ></echarts>
            </div>
          </div>
        </div>

        <div class="ts-card ts-card--flush space-y-4 min-w-0 animate-subtleUp">
          <div class="space-y-1 px-6">
            <h2 class="text-lg font-semibold text-ink">Cobertura por area</h2>
            <p class="text-sm text-muted">Porcentaje de participacion por departamento.</p>
          </div>
          <div class="px-0">
            <echarts
              class="block h-[28rem] w-full animate-fadeIn"
              [theme]="'tsMono'"
              [options]="coverageByDepartmentOption()"
              [initOpts]="chartInitOpts"
              [autoResize]="true"
            ></echarts>
          </div>
        </div>

        <div class="ts-card space-y-4 min-w-0 animate-subtleUp">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Ranking de departamentos</h2>
            <p class="text-sm text-muted">Top 5 y areas a reforzar segun el filtro actual.</p>
          </div>
          <div class="grid gap-6 md:grid-cols-2">
            <div>
              <h3 class="font-semibold text-emerald-600">Top 5</h3>
              <div class="space-y-3" *ngIf="rankingTop().length; else rankingEmpty">
                <ng-container *ngFor="let item of rankingTop(); trackBy: trackById">
                  <div class="flex justify-between text-sm font-medium text-ink">
                    <span class="mr-3 line-clamp-1">{{ item.name }}</span>
                    <span>{{ formatPercent(item.value) }}</span>
                  </div>
                  <div class="h-2 rounded bg-slate-200">
                    <div class="h-full rounded bg-emerald-500" [style.width.%]="item.value"></div>
                  </div>
                </ng-container>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-rose-600">Areas a reforzar</h3>
              <div class="space-y-3" *ngIf="rankingBottom().length; else rankingEmpty">
                <ng-container *ngFor="let item of rankingBottom(); trackBy: trackById">
                  <div class="flex justify-between text-sm font-medium text-ink">
                    <span class="mr-3 line-clamp-1">{{ item.name }}</span>
                    <span>{{ formatPercent(item.value) }}</span>
                  </div>
                  <div class="h-2 rounded bg-slate-200">
                    <div class="h-full rounded bg-rose-500" [style.width.%]="item.value"></div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
          <ng-template #rankingEmpty>
            <p class="text-sm text-muted">Sin datos suficientes.</p>
          </ng-template>
        </div>

        <div class="ts-card space-y-4 min-w-0 animate-subtleUp" *ngIf="hasEmployeesDistribution()">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-ink">Dispersión de empleados</h2>
            <p class="text-sm text-muted">Promedio individual y estadio asociado.</p>
          </div>
          <echarts
            class="block h-[26rem] w-full animate-fadeIn"
            [theme]="'tsMono'"
            [options]="employeeScatterOption()"
            [initOpts]="chartInitOpts"
            [autoResize]="true"
          ></echarts>
        </div>
      </ng-container>
    </section>

    <!-- Estado de carga -->
    <ng-template #loadingState>
      <section class="ts-card space-y-4">
        <div class="animate-pulse space-y-4">
          <div class="h-4 w-1/4 rounded bg-border"></div>
          <div class="h-72 rounded-lg bg-border"></div>
        </div>
      </section>
    </ng-template>

    <!-- Estado vacío -->
    <ng-template #emptyState>
      <section class="ts-card text-center text-sm text-muted">
        No encontramos resultados para los filtros aplicados. Ajusta los criterios o espera nuevas respuestas.
      </section>
    </ng-template>
  </div>

  <!-- Modal de generación de informes -->
  <ts-modal title="Generar informes" [open]="reportModalOpen()" (close)="closeReportModal()">
    <div class="space-y-6">
      <div class="space-y-3">
        <p class="text-sm text-muted">Selecciona uno o varios formatos para exportar:</p>
        <div class="space-y-2">
          <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-[#F8FAFC] transition-colors">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-border text-primary focus:ring-2 focus:ring-primary"
              [(ngModel)]="selectedFormats.pdf"
            />
            <div class="flex-1">
              <span class="font-semibold text-ink">PDF</span>
              <p class="text-xs text-muted">Informe visual con gráficos bien distribuidos</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-[#F8FAFC] transition-colors">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-border text-primary focus:ring-2 focus:ring-primary"
              [(ngModel)]="selectedFormats.csv"
            />
            <div class="flex-1">
              <span class="font-semibold text-ink">CSV</span>
              <p class="text-xs text-muted">Todos los datos de encuestas en formato CSV</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-[#F8FAFC] transition-colors">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-border text-primary focus:ring-2 focus:ring-primary"
              [(ngModel)]="selectedFormats.json"
            />
            <div class="flex-1">
              <span class="font-semibold text-ink">JSON</span>
              <p class="text-xs text-muted">Todos los datos de encuestas en formato JSON</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-[#F8FAFC] transition-colors">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-border text-primary focus:ring-2 focus:ring-primary"
              [(ngModel)]="selectedFormats.xml"
            />
            <div class="flex-1">
              <span class="font-semibold text-ink">XML</span>
              <p class="text-xs text-muted">Todos los datos de encuestas en formato XML</p>
            </div>
          </label>
          <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-[#F8FAFC] transition-colors">
            <input
              type="checkbox"
              class="h-4 w-4 rounded border-border text-primary focus:ring-2 focus:ring-primary"
              [(ngModel)]="selectedFormats.excel"
            />
            <div class="flex-1">
              <span class="font-semibold text-ink">Excel</span>
              <p class="text-xs text-muted">Datos y gráficos combinados en archivo Excel</p>
            </div>
          </label>
        </div>
      </div>

      <div *ngIf="reportError()" class="rounded-md border border-error/30 bg-error/10 px-4 py-3 text-sm text-error">
        {{ reportError() }}
      </div>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          class="ts-btn ts-btn--secondary"
          (click)="closeReportModal()"
          [disabled]="generatingReports()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="ts-btn"
          (click)="generateReports()"
          [disabled]="generatingReports() || !hasSelectedFormats()"
        >
          {{ generatingReports() ? 'Generando...' : 'Generar informes' }}
        </button>
      </div>
    </div>
  </ts-modal>

  <!-- Modal de comprobante -->
  <ts-modal title="Comprobante de exportación" [open]="receiptModalOpen()" (close)="closeReceiptModal()">
    <div class="space-y-4" *ngIf="exportReceipt()">
      <div class="rounded-xl border border-border bg-[#F8FAFC] p-4 space-y-3">
        <div class="flex items-center justify-between border-b border-border pb-2">
          <span class="text-sm font-semibold text-ink">Usuario:</span>
          <span class="text-sm text-muted">{{ exportReceipt()!.usuario }}</span>
        </div>
        <div class="flex items-center justify-between border-b border-border pb-2">
          <span class="text-sm font-semibold text-ink">Fecha y hora:</span>
          <span class="text-sm text-muted">{{ exportReceipt()!.fechaHora }}</span>
        </div>
        <div class="space-y-2">
          <span class="text-sm font-semibold text-ink block">Filtros aplicados:</span>
          <ul class="text-sm text-muted space-y-1 ml-4">
            <li *ngFor="let filter of exportReceipt()!.filtros" class="list-disc">{{ filter }}</li>
          </ul>
        </div>
        <div class="space-y-2 pt-2 border-t border-border">
          <span class="text-sm font-semibold text-ink block">Formatos generados:</span>
          <div class="flex flex-wrap gap-2">
            <span
              *ngFor="let format of exportReceipt()!.formatos"
              class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-medium text-primary"
            >
              {{ format }}
            </span>
          </div>
        </div>
      </div>
      <div class="flex justify-end">
        <button type="button" class="ts-btn" (click)="closeReceiptModal()">Cerrar</button>
      </div>
    </div>
  </ts-modal>
</div>
